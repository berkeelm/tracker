<html>

<head>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.30.1/moment.min.js"></script>
</head>

<body>
    <div class="container-fluid">
		v1
		
        <div class="row mt-3">
            <div class="col-6">
                <input onchange="onDateChange()" id="inputDate" class="form-control" type="date" />
            </div>
            <div class="col-6">
                <input id="inputTime" class="form-control" type="time" disabled />
            </div>
        </div>
        <div class="row" id="mainList"></div>
        <div class="row" id="subList"></div>
    </div>
</body>

<script>
    var lastSelectedName = undefined;

    var products = [
        {
            name: "Su",
            unit: 'litre',
            subItems: [
                {
                    name: '0.33 Litre',
                    value: 0.33
                },
                {
                    name: '0.5 Litre',
                    value: 0.5
                },
                {
                    name: '1 Litre',
                    value: 1
                },
                {
                    name: '1.5 Litre',
                    value: 1.5
                }
            ]
        },
        {
            name: "Sigara",
            unit: 'adet',
            subItems: [
                {
                    name: 'Sigara',
                    value: 1
                }
            ]
        }
    ];

    function onDateChange() {
        if (!lastSelectedName)
            navigateFirstScreen();
        else
            navigateSecondScreen(lastSelectedName);
    }

    function navigateSecondScreen(_name) {
        lastSelectedName = _name;

        var date = $("#inputDate").val();

        var data = JSON.parse((localStorage.getItem("data-" + date) ?? '[]'));

        $("#mainList").hide();
        $("#subList").show();

        var subItems = products.find(x => x.name == _name).subItems;

        var html = "";

        var unit = products.find(x => x.name == _name).unit;

        for (var i = 0; i < subItems.length; i++) {
            var item = subItems[i];
            var value = data.find(x => x.name == _name)?.values?.find(x => x.name == item.name)?.value ?? 0;

            html += `
            <div class="col-12 mt-3">
                <div class="row">
                    <div class="col-8">
                        <button onclick="" style="text-align: left;" class="btn w-100">${item.name} (${value} ${unit})</button>
                    </div>
                    <div class="col-2">
                        <button onclick="increaseDecrease('${item.name}', '-')" class="btn btn-primary w-100">-</button>
                    </div>
                    <div class="col-2">
                        <button onclick="increaseDecrease('${item.name}', '+')" class="btn btn-primary w-100">+</button>
                    </div>
                </div>
            </div>
            `;
        }

        html += `
        <div class="col-12 mt-3">
            <h3 style="margin: 0; padding: 0; text-align: center;">TOPLAM: ${sumOfNumbers(data.find(x => x.name == _name)?.values?.map(x => x.unitValue * x.value))} ${unit}</h3>
        </div>
        `;

        html += `
        <div class="col-12 mt-3">
            <button onclick="navigateFirstScreen()" class="btn btn-primary w-100">Geri</button>
        </div>
        `;

        $("#subList").html(html);
    }

    function increaseDecrease(_subName, _process) {
        var date = $("#inputDate").val();

        var data = JSON.parse((localStorage.getItem("data-" + date) ?? '[]'));

        var subData = data.find(x => x.name == lastSelectedName);

        if (!subData) {
            data.push({ name: lastSelectedName, unit: products.find(x => x.name == lastSelectedName).unit, values: [] });
            subData = data.find(x => x.name == lastSelectedName);
        }

        var valueData = subData.values.find(x => x.name == _subName);

        if (!valueData) {
            subData.values.push({ name: _subName, unitValue: products.find(x => x.name == lastSelectedName).subItems.find(x => x.name == _subName).value, value: 0 });
            valueData = subData.values.find(x => x.name == _subName);
        }

        if (_process == "+")
            valueData.value += 1;
        else if (_process == "-")
            valueData.value -= 1;

        localStorage.setItem("data-" + date, JSON.stringify(data));

        navigateSecondScreen(lastSelectedName);
    }

    function navigateFirstScreen() {
        lastSelectedName = undefined;

        $("#mainList").show();
        $("#subList").hide();

        var date = $("#inputDate").val();

        var data = JSON.parse((localStorage.getItem("data-" + date) ?? '[]'));

        var html = "";

        for (var i = 0; i < products.length; i++) {
            var item = products[i];

            ;

            html += `
            <div class="col-12 mt-3">
                <button onclick="navigateSecondScreen('${item.name}')" class="btn btn-primary w-100">${item.name} (${sumOfNumbers(data.find(x => x.name == item.name)?.values?.map(x => x.unitValue * x.value))} ${item.unit})</button>
            </div>
            `;
        }

        $("#mainList").html(html);
    }

    function sumOfNumbers(arr) {
        if (!arr || arr.length == 0)
            return 0;

        var sum = 0;

        for (var i = 0; i < arr.length; i++)
            sum += arr[i];

        return sum.toFixed(2);
    }

    $(document).ready(() => {
        $("#inputDate").val(moment().format('YYYY-MM-DD'));
        $("#inputTime").val(moment().format('HH:mm'));

        navigateFirstScreen();
    });
</script>

</html>